<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nook - „ÉÜ„ÉÉ„ÇØÊÉÖÂ†±ÂèéÈõÜ„ÉÑ„Éº„É´</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            padding-top: 56px;
            background-color: #f8f9fa;
        }
        .content-wrapper {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            padding: 20px;
            margin-bottom: 20px;
        }
        .date-selector {
            margin-bottom: 20px;
        }
        .nav-tabs {
            margin-bottom: 15px;
        }
        .markdown-body {
            padding: 0;
        }
        .divider {
            border-top: 1px solid rgba(0,0,0,.1);
            margin: 2rem 0;
        }
        .weather-info {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        .weather-icon {
            font-size: 1.5rem;
            margin-right: 5px;
        }
        .chat-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow: hidden;
        }
        .chat-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-body {
            padding: 15px;
            overflow-y: auto;
            max-height: 300px;
        }
        .chat-footer {
            padding: 10px;
            border-top: 1px solid #dee2e6;
        }
        .message {
            margin-bottom: 10px;
            max-width: 80%;
        }
        .user-message {
            margin-left: auto;
            background-color: #d1ecf1;
            padding: 8px 12px;
            border-radius: 15px 15px 0 15px;
        }
        .bot-message {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 15px 15px 15px 0;
        }
        .close-chat {
            cursor: pointer;
            font-size: 1.2rem;
        }
        @media (max-width: 768px) {
            .chat-container {
                width: 90%;
                bottom: 10px;
                right: 5%;
                left: 5%;
            }
        }
        .chat-button {
            margin-left: 10px;
            font-size: 0.8rem;
            cursor: pointer;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">Nook</a>
            <div class="d-flex align-items-center">
                <div class="weather-info text-white">
                    <span class="weather-icon">{{ weather_data.weather_icon }}</span>
                    <span>{{ weather_data.temp }}‚ÑÉ</span>
                </div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">„Éõ„Éº„É†</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="date-selector d-flex justify-content-between align-items-center">
                    <h2>{{ date }} „ÅÆÊÉÖÂ†±</h2>
                    <div>
                        <select id="dateSelect" class="form-select" onchange="window.location.href='/?date=' + this.value">
                            {% for available_date in available_dates %}
                            <option value="{{ available_date }}" {% if available_date == date %}selected{% endif %}>{{ available_date }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    {% for app_name in app_names %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.index == 1 %}active{% endif %}" id="{{ app_name }}-tab" data-bs-toggle="tab" data-bs-target="#{{ app_name }}" type="button" role="tab">
                            {{ app_name.replace('_', ' ').title() }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                <div class="tab-content" id="myTabContent">
                    {% for app_name in app_names %}
                    <div class="tab-pane fade {% if loop.index == 1 %}show active{% endif %}" id="{{ app_name }}" role="tabpanel">
                        <div class="content-wrapper">
                            <article class="markdown-body" id="{{ app_name }}-content">
                                <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØJavaScript„ÅßÂ§âÊèõ„Åï„Çå„Åæ„Åô -->
                            </article>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- „ÉÅ„É£„ÉÉ„Éà„Ç¶„Ç£„É≥„Éâ„Ç¶ -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <div id="chatTitle">„Åì„ÅÆË®ò‰∫ã„Å´„Å§„ÅÑ„Å¶Ë≥™Âïè„Åô„Çã</div>
            <span class="close-chat" onclick="closeChat()">&times;</span>
        </div>
        <div id="chatBody" class="chat-body">
            <div class="bot-message message">„Åì„ÅÆË®ò‰∫ã„Å´„Å§„ÅÑ„Å¶‰Ωï„ÅãË≥™Âïè„Åå„ÅÇ„Çä„Åæ„Åô„ÅãÔºü</div>
        </div>
        <div class="chat-footer">
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ...">
                <button class="btn btn-primary" onclick="sendMessage()">ÈÄÅ‰ø°</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Markdown„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        document.addEventListener('DOMContentLoaded', function() {
            const contents = {
                {% for app_name in app_names %}
                "{{ app_name }}": `{{ contents[app_name] | replace('`', '\\`') | safe }}`,
                {% endfor %}
            };

            for (const [appName, content] of Object.entries(contents)) {
                const element = document.getElementById(`${appName}-content`);
                if (element) {
                    let htmlContent = '';
                    try {
                        // Markdown„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                        htmlContent = marked.parse(content);
                    } catch (e) {
                        console.error(`Error parsing markdown for ${appName}:`, e);
                        htmlContent = `<p>Error rendering content: ${e.message}</p><pre>${content}</pre>`;
                    }
                    element.innerHTML = htmlContent;

                    // ÂêÑË¶ãÂá∫„Åó„Å´„ÉÅ„É£„ÉÉ„Éà„Ç¢„Ç§„Ç≥„É≥„ÇíËøΩÂä†
                    const headings = element.querySelectorAll('h1, h2, h3');
                    headings.forEach((heading, index) => {
                        const chatButton = document.createElement('span');
                        chatButton.className = 'chat-button';
                        chatButton.innerHTML = 'üí¨ Ë≥™Âïè„Åô„Çã';
                        chatButton.setAttribute('data-topic', `${appName}-${index}`);
                        chatButton.setAttribute('data-title', heading.textContent);
                        chatButton.onclick = function() {
                            openChat(this.getAttribute('data-topic'), this.getAttribute('data-title'), appName);
                        };
                        heading.appendChild(chatButton);
                    });
                }
            }
        });

        // „ÉÅ„É£„ÉÉ„ÉàÈñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let currentTopic = '';
        let currentAppName = '';
        let chatHistory = {};

        // „ÉÅ„É£„ÉÉ„Éà„ÇíÈñã„Åè
        function openChat(topic, title, appName) {
            currentTopic = topic;
            currentAppName = appName;
            
            // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆÂàùÊúüÂåñ
            if (!chatHistory[topic]) {
                chatHistory[topic] = [];
            }
            
            // „ÉÅ„É£„ÉÉ„Éà„ÅÆ„Çø„Ç§„Éà„É´„ÇíË®≠ÂÆö
            document.getElementById('chatTitle').textContent = title;
            
            // „ÉÅ„É£„ÉÉ„Éà„Éú„Éá„Ç£„Çí„ÇØ„É™„Ç¢
            const chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = '';
            
            // Â±•Ê≠¥„ÇíË°®Á§∫
            chatHistory[topic].forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.role}-message`;
                messageDiv.innerHTML = msg.role === 'bot' ? marked.parse(msg.text) : msg.text;
                chatBody.appendChild(messageDiv);
            });
            
            // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„Åå„Å™„Åë„Çå„Å∞ËøΩÂä†
            if (chatHistory[topic].length === 0) {
                const welcomeMsg = {
                    role: 'bot',
                    text: '„Åì„ÅÆË®ò‰∫ã„Å´„Å§„ÅÑ„Å¶‰Ωï„ÅãË≥™Âïè„Åå„ÅÇ„Çä„Åæ„Åô„ÅãÔºü'
                };
                chatHistory[topic].push(welcomeMsg);
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message';
                messageDiv.textContent = welcomeMsg.text;
                chatBody.appendChild(messageDiv);
            }
            
            // „ÉÅ„É£„ÉÉ„Éà„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíË°®Á§∫
            document.getElementById('chatContainer').style.display = 'block';
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„Éï„Ç©„Éº„Ç´„Çπ
            document.getElementById('messageInput').focus();
            
            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å´
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // „ÉÅ„É£„ÉÉ„Éà„ÇíÈñâ„Åò„Çã
        function closeChat() {
            document.getElementById('chatContainer').style.display = 'none';
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            const chatBody = document.getElementById('chatBody');
            
            // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.textContent = message;
            chatBody.appendChild(userMessageDiv);
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Çπ„ÇØ„É≠„Éº„É´
            messageInput.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Å´ËøΩÂä†
            chatHistory[currentTopic].push({
                role: 'user',
                text: message
            });
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message';
            loadingDiv.textContent = 'ËÄÉ„Åà‰∏≠...';
            chatBody.appendChild(loadingDiv);
            
            try {
                // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Çí„Ç∑„É™„Ç¢„É©„Ç§„Ç∫
                const historyText = chatHistory[currentTopic]
                    .filter(msg => msg.role !== 'bot' || msg.text !== '„Åì„ÅÆË®ò‰∫ã„Å´„Å§„ÅÑ„Å¶‰Ωï„ÅãË≥™Âïè„Åå„ÅÇ„Çä„Åæ„Åô„ÅãÔºü')
                    .map(msg => `${msg.role === 'user' ? '„É¶„Éº„Ç∂„Éº' : 'AI'}: ${msg.text}`)
                    .join('\n\n');
                
                // API„É™„ÇØ„Ç®„Çπ„Éà
                const response = await fetch(`/chat/${currentTopic}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        markdown: document.getElementById(`${currentAppName}-content`).textContent,
                        chat_history: historyText
                    })
                });
                
                const data = await response.json();
                
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
                chatBody.removeChild(loadingDiv);
                
                // ÂøúÁ≠î„ÇíË°®Á§∫
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message bot-message';
                botMessageDiv.innerHTML = marked.parse(data.response);
                chatBody.appendChild(botMessageDiv);
                
                // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Å´ËøΩÂä†
                chatHistory[currentTopic].push({
                    role: 'bot',
                    text: data.response
                });
                
            } catch (error) {
                console.error('Error sending message:', error);
                
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
                chatBody.removeChild(loadingDiv);
                
                // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message bot-message';
                errorDiv.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                chatBody.appendChild(errorDiv);
            }
            
            // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúÄ‰∏ãÈÉ®„Å´
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Enter„Ç≠„Éº„Åß„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>